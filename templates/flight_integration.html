{% extends 'base.html' %}

{% block title %}Flight Integration - Air Cargo System{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex align-items-center mb-4">
                <a href="/" class="btn btn-outline-secondary me-3">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <h1 class="display-5 fw-bold mb-0">Flight Integration</h1>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-airplane-engines me-2"></i>Flight Management</h5>
                </div>
                <div class="card-body">
                    <p class="lead mb-4">
                        Manage flight schedules, cargo capacity, and integration with airline systems. 
                        This page provides tools for flight administrators to maintain accurate flight information.
                    </p>
                    
                    <div class="row mb-4">
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <i class="bi bi-plus-circle text-primary" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2">Add New Flight</h6>
                                    <p class="small text-muted">Register a new flight with schedule and capacity details</p>
                                    <button class="btn btn-sm btn-outline-primary" onclick="showAddFlightModal()">
                                        <i class="bi bi-plus me-1"></i>Create
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <i class="bi bi-search text-success" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2">Search Flights</h6>
                                    <p class="small text-muted">Find and view existing flight information</p>
                                    <button class="btn btn-sm btn-outline-success" onclick="showSearchFlights()">
                                        <i class="bi bi-search me-1"></i>Search
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <i class="bi bi-pencil text-warning" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2">Update Flights</h6>
                                    <p class="small text-muted">Modify flight details and capacity information</p>
                                    <button class="btn btn-sm btn-outline-warning" onclick="showUpdateFlights()">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <i class="bi bi-bar-chart text-info" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2">Capacity Reports</h6>
                                    <p class="small text-muted">View cargo capacity utilization reports</p>
                                    <button class="btn btn-sm btn-outline-info" onclick="showCapacityReports()">
                                        <i class="bi bi-bar-chart me-1"></i>Reports
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Flight List Section -->
                    <div id="flightListSection">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="bi bi-list me-2"></i>Recent Flights</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadFlights()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                            </button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Flight #</th>
                                        <th>Airline</th>
                                        <th>Route</th>
                                        <th>Departure</th>
                                        <th>Arrival</th>
                                        <th>Cargo Capacity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="flightsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="text-muted py-4">
                                                <i class="bi bi-airplane" style="font-size: 2rem;"></i>
                                                <p class="mt-2 mb-0">Click "Refresh" to load flight data</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="d-flex justify-content-center">
                            <nav>
                                <ul class="pagination" id="paginationControls">
                                    <!-- Pagination will be populated dynamically -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Flight Modal -->
<div class="modal fade" id="addFlightModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add New Flight</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addFlightForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="flightNumber" class="form-label">Flight Number *</label>
                            <input type="text" class="form-control bg-dark text-white" id="flightNumber" name="flight_number" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="airlineName" class="form-label">Airline Name *</label>
                            <input type="text" class="form-control bg-dark text-white" id="airlineName" name="airline_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="origin" class="form-label">Origin Airport *</label>
                            <input type="text" class="form-control bg-dark text-white" id="origin" name="origin" placeholder="3-letter code" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="destination" class="form-label">Destination Airport *</label>
                            <input type="text" class="form-control bg-dark text-white" id="destination" name="destination" placeholder="3-letter code" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="departureDatetime" class="form-label">Departure Date & Time *</label>
                            <input type="datetime-local" class="form-control bg-dark text-white" id="departureDatetime" name="departure_datetime" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="arrivalDatetime" class="form-label">Arrival Date & Time *</label>
                            <input type="datetime-local" class="form-control bg-dark text-white" id="arrivalDatetime" name="arrival_datetime" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="maxCargoWeight" class="form-label">Max Cargo Weight (kg) *</label>
                            <input type="number" class="form-control bg-dark text-white" id="maxCargoWeight" name="max_cargo_weight" min="1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="availableCargoWeight" class="form-label">Available Cargo Weight (kg) *</label>
                            <input type="number" class="form-control bg-dark text-white" id="availableCargoWeight" name="available_cargo_weight" min="0" required>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="aircraftType" class="form-label">Aircraft Type</label>
                            <input type="text" class="form-control bg-dark text-white" id="aircraftType" name="aircraft_type">
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary" id="addFlightSubmitBtn">
                            <i class="bi bi-plus-circle me-2"></i>Add Flight
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize date fields with current date
    const now = new Date();
    const formattedNow = now.toISOString().slice(0, 16);
    document.getElementById('departureDatetime').value = formattedNow;
    
    // Set arrival time to 2 hours later
    const arrivalDate = new Date(now.getTime() + 2 * 60 * 60 * 1000);
    const formattedArrival = arrivalDate.toISOString().slice(0, 16);
    document.getElementById('arrivalDatetime').value = formattedArrival;
    
    // Form handlers
    document.getElementById('addFlightForm').addEventListener('submit', addFlight);
});

// Show Add Flight Modal
function showAddFlightModal() {
    const modal = new bootstrap.Modal(document.getElementById('addFlightModal'));
    modal.show();
}

// Show Search Flights
function showSearchFlights() {
    loadFlights();
    showAlert('Flight search functionality ready. Use the refresh button to load flights.', 'info');
}

// Show Update Flights
function showUpdateFlights() {
    loadFlights();
    showAlert('Flight update functionality ready. Select a flight from the list to edit.', 'info');
}

// Show Capacity Reports
function showCapacityReports() {
    window.open('https://example.com/reports', '_blank');
    showAlert('Capacity reports would be displayed in a new window in a real implementation.', 'info');
}

// Add Flight
async function addFlight(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Convert numeric fields
    data.max_cargo_weight = parseInt(data.max_cargo_weight);
    data.available_cargo_weight = parseInt(data.available_cargo_weight);
    
    const submitBtn = document.getElementById('addFlightSubmitBtn');
    showLoading(submitBtn);
    
    try {
        const response = await axios.post(`${API_BASE_URL}/flights/`, data);
        const flight = response.data;
        
        // Hide modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('addFlightModal'));
        modal.hide();
        
        // Reset form
        form.reset();
        
        // Reload flights
        loadFlights();
        
        showAlert(`Flight ${flight.flight_number} added successfully!`, 'success');
        
    } catch (error) {
        console.error('Error adding flight:', error);
        let errorMessage = 'Error adding flight. Please try again.';
        if (error.response && error.response.data) {
            if (typeof error.response.data === 'object') {
                errorMessage = Object.values(error.response.data).flat().join(', ') || errorMessage;
            } else if (typeof error.response.data === 'string') {
                errorMessage = error.response.data;
            }
        }
        showAlert(errorMessage, 'danger');
    } finally {
        hideLoading(submitBtn, '<i class="bi bi-plus-circle me-2"></i>Add Flight');
    }
}

// Load Flights
let currentPage = 1;
const pageSize = 10;

async function loadFlights(page = 1) {
    currentPage = page;
    
    try {
        const response = await axios.get(`${API_BASE_URL}/flights/?page=${page}&page_size=${pageSize}`);
        const flights = response.data.results || response.data;
        const totalCount = response.data.count || flights.length;
        const totalPages = Math.ceil(totalCount / pageSize);
        
        displayFlights(flights);
        setupPagination(currentPage, totalPages);
        
    } catch (error) {
        console.error('Error loading flights:', error);
        document.getElementById('flightsTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Error loading flights. Please try again.
                </td>
            </tr>
        `;
        document.getElementById('paginationControls').innerHTML = '';
    }
}

// Display Flights
function displayFlights(flights) {
    const tbody = document.getElementById('flightsTableBody');
    
    if (!flights || flights.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="bi bi-airplane" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">No flights found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    flights.forEach(flight => {
        html += `
            <tr>
                <td>${flight.flight_number}</td>
                <td>${flight.airline_name}</td>
                <td>${flight.origin} â†’ ${flight.destination}</td>
                <td>${formatDateTime(flight.departure_datetime)}</td>
                <td>${formatDateTime(flight.arrival_datetime)}</td>
                <td>
                    <span class="badge bg-primary">${flight.available_cargo_weight}/${flight.max_cargo_weight} kg</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" onclick="editFlight(${flight.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteFlight(${flight.id})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Setup Pagination
function setupPagination(currentPage, totalPages) {
    const pagination = document.getElementById('paginationControls');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Previous button
    if (currentPage > 1) {
        html += `<li class="page-item"><a class="page-link bg-dark text-white" href="#" onclick="loadFlights(${currentPage - 1})">Previous</a></li>`;
    } else {
        html += `<li class="page-item disabled"><span class="page-link bg-dark text-muted">Previous</span></li>`;
    }
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            html += `<li class="page-item active"><span class="page-link bg-primary border-primary">${i}</span></li>`;
        } else {
            html += `<li class="page-item"><a class="page-link bg-dark text-white" href="#" onclick="loadFlights(${i})">${i}</a></li>`;
        }
    }
    
    // Next button
    if (currentPage < totalPages) {
        html += `<li class="page-item"><a class="page-link bg-dark text-white" href="#" onclick="loadFlights(${currentPage + 1})">Next</a></li>`;
    } else {
        html += `<li class="page-item disabled"><span class="page-link bg-dark text-muted">Next</span></li>`;
    }
    
    pagination.innerHTML = html;
}

// Edit Flight
function editFlight(flightId) {
    showAlert('Flight edit functionality would be implemented in a real system.', 'info');
}

// Delete Flight
function deleteFlight(flightId) {
    if (confirm('Are you sure you want to delete this flight? This action cannot be undone.')) {
        showAlert('Flight delete functionality would be implemented in a real system.', 'info');
    }
}
</script>
{% endblock %}